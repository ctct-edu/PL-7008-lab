---
lab:
    title: 'Copilot Studioでエージェントを作成する'
    module: 'Microsoft Copilot Studioで初期エージェントを構築する'
---

# Copilot Studioでエージェントを作成する

この演習では、Copilot Studioを使って、架空の企業における経費精算に関する従業員の質問に答えるシンプルなエージェントを作成します。

所要時間は約**30分**です。

> **注**: この演習を始める前に、Copilot Studioのライセンスを取得しているか、[無料試用版](https://go.microsoft.com/fwlink/p/?linkid=2252605)にサインアップしておいてください。

## エージェントを作成する

それでは、Copilot Studioで新しいエージェントを作成してみましょう。最初は基本的な機能だけですが、演習を進めながら段階的に機能を追加していきます。

1. Webブラウザで**Copilot Studio**（`https://copilotstudio.microsoft.com/`）を開き、必要に応じてサインインします。ウェルカムメッセージが表示された場合はスキップしてください。

    > **注**: Copilot Studioを初めて開くと、最初のエージェントを作成するためのチャット画面が表示されることがあります。その場合は、画面右上の **...** メニュー（**作成**ボタンの隣）から**エージェント作成をキャンセル**を選んで、Copilot Studioのホーム画面に移動してください。

1. Copilot Studioのホーム画面が表示されます。

    ホーム画面では、新しいエージェントを作成したり、最近作業したエージェントを確認したりできます。画面上部には、エージェントが定義されているPower Apps**環境**が表示されています。

    ここでは、完全に新規のエージェントを作成することも、テンプレートから始めることもできます。
    今回は、作りたいエージェントの内容を説明することで、ゼロから新しいエージェントを作成します。

1. **構築開始にあたって、エージェントに行わせたいことを説明**の欄に、以下の内容を入力し、送信します。

    ```prompt
    従業員の経費精算を支援する日本語エージェントを作成してください。
    ```
1. Copilot Studioが作成したエージェントを確認しましょう。

1. **指示**セクションの**編集**アイコンをクリックし、一般ガイドライン内に、以下を追加して保存します。

    `- フレンドリーかつプロフェッショナルな対応を心がける`

    `- 税務に関するアドバイスは行わない`

1. **ナレッジ**セクションで、**エージェントがすべての公開Webサイトを検索できるようにする**を**無効**にします。

1. **エージェントをテスト**ペインで、次のように入力してみます:
    > **注意:** テストペインが開いていない場合、メニュー右側にあるテストボタンをクリックしてください。

    ```prompt
    こんにちは
    ```

    適切な挨拶が返ってくるはずです。

    続いて、次のように入力してみましょう:

    ```prompt
    経費精算の提出について誰に連絡すればよいですか?
    ```

    今回の返答も適切かもしれませんが、やや一般的な内容になっているでしょう。実際の企業では、担当部署のメールアドレスや電話番号など、より具体的な情報を提供したいところです。

    もう一つ試してみましょう:

    ```prompt
    宿泊費の経費上限はいくらですか?
    ```

    この質問への回答も一般的な内容になりがちです。実際には、自社の経費規程に基づいた具体的な金額を回答できるようにしたいですね。

1. **エージェントをテスト**ペインを閉じます。

## エージェントの*トピック*を管理する

*トピック*を使うことで、よくある質問やリクエストなど、ユーザーから想定される入力（*トリガー*）に対して、明確な応答を設定できます。

1. エージェントの画面で**トピック**タブを選び、登録されているトピックを確認します。

    初期状態では、ユーザーの入力でトリガーされる***カスタム***トピックと、エラーや想定外の入力などの特定のイベントでトリガーされる***システム***トピックがいくつか用意されています。カテゴリでフィルタリングすることも、**すべて**フィルタですべて表示することもできます。

1. **あいさつ**カスタムトピックを選んで、**オーサリングキャンバス**（トピックを作成・編集するためのビジュアルエディター）で開きます。以下のような画面が表示されます:

    **挨拶**トピックは、以下のようなフレーズが入力に含まれるとトリガーされます:

    - *こんにちは*
    - *おはようございます*
    - *こんばんは*
    - *やあ*
    - *ハロー*

    トリガーされると、「こんにちは、ご用件をお申し付けください。」というメッセージが返されます。先ほどテストした際の挨拶の応答は、このトピックによるものです。

1. **トピック**画面に戻り、**システム**トピックを確認してみましょう。会話中によく発生するイベントに対応したトピックが含まれています。特に以下の2つに注目してください:
    - **会話の強化**: ユーザーのメッセージに対応するトピックが見つからない（ユーザーの**意図**が不明な）場合にトリガーされ、生成AIを使って応答を試みます。
    - **フォールバック**: 意図が不明で生成AIでも適切な応答ができない場合の最終手段として機能します。最大3回まで再試行を促し、必要に応じて人間のオペレーターにエスカレーションして会話を終了します。
1. **トピック**画面に戻り、**+ トピックを追加**メニューから**トピック** \> **Copilotで説明から追加**を選びます。

1. **Copilotで説明から追加**ダイアログで、新しいトピック名を「`経費連絡先について尋ねる`」とし、以下のテキストを入力してCopilot Studioにこのトピックの動作を指示します:

    ```prompt
    ユーザーが経費精算について誰に連絡すればよいかを尋ねたら、finance[at]contoso.com にメールを送信するように案内してください。
    ```

    > **注**: Copilotの生成結果は毎回異なる可能性があります。期待通りの結果にならない場合は、プロンプトを調整してみてください。

1. **作成**をクリックします。

1. 確認画面が表示されたら、**クリップボードにコピーされたテキストと画像を表示する**を**許可**します。

1. しばらくすると、**経費連絡先について尋ねる**という新しいトピックが作成され、オーサリングキャンバスで開きます。以下のような構成になっているはずです:

    この新しいトピックは、経費の連絡先を尋ねるようなフレーズでトリガーされ、適切なメールアドレスを案内するメッセージを返します。

    > **重要**: トピックの構成が上記の画像と大きく異なる場合は、一度削除して作り直してください。

1. 画面右上の**保存**ボタンをクリックして、新しいトピックをエージェントに保存します。

1. **テスト**ペインを開き、以下のように入力してみます:

    ```prompt
    経費精算の提出について誰に連絡すればよいですか?
    ```

    先ほど追加したトピックに基づいた応答が返ってくるはずです（入力した文言がトリガーフレーズと完全に一致していなくても、意味的に近ければトピックが起動します）。

## 生成AI応答のためのナレッジソースを追加する

想定されるすべての質問に対してトピックを作成することは現実的ではありません。現在、エージェントは*会話を強化する*トピックを使って言語モデルからAI応答を生成していますが、これでは一般的な回答しか返せません。より具体的で関連性の高い情報を提供するには、生成AI応答の根拠となる*ナレッジソース*を用意する必要があります。

1. **ナレッジ**タブを選んでエージェントに登録されているナレッジソースを確認します（現時点では何も登録されていないはずです）。

1. **+ ナレッジを追加**をクリックし、エージェントに追加できるナレッジソースの種類を確認します。

1. **One Drive**を選び、事前にコピーしたファイル **`Expenses_Policy_Japanese.docx`** を選んで**エージェントに追加**します。

    > **注**: ファイルのアップロード後、インデックス化が完了するまで待つ必要があります。10分以上かかる場合があります。

## ファイルのインデックス化を確認する

アップロードしたファイルのインデックス化が完了しているか確認しましょう。まだ処理中の場合は、コーヒーブレイクを取りながら、数分おきにチェックしてみてください。

1. **ナレッジ**タブを選びます。

1. ファイルアップロードの**ステータス**を確認します。まだ**進行中**の場合は、**準備完了**になるまで数分おきに画面を更新してください。

1. ファイルの準備ができたら、**トピック**ページを開き、**会話の強化**システムトピックを確認します。このトピックは、ユーザーの意図が不明な場合にトリガーされ、アップロードしたファイルなどのナレッジソースを使って生成AI応答を作成しようとします。

    > **注**: 追加したカスタムナレッジソースに関連する回答が見つからない場合、言語モデル自体が持つ知識を使って、より一般的な回答を提供することがあります。生成AI応答をより細かく制御したい場合は、トピックを設定して特定のナレッジストアのみを検索対象にすることができます。

## エージェントをテストする

エージェントが動作するようになったので、実際にテストして、利用準備ができているか確認しましょう。

1. 画面上部の**テスト**アイコンをクリックして、**エージェントをテスト**ペインを開きます。

1. **エージェントをテスト**ペインの**省略記号 ...** メニューから、**トピック間のトラック**を**オン**に切り替えます。

1. **テスト**ペインを広げて、新しいテストセッションを開始します。次のように入力してみましょう:

    ```prompt
    宿泊費の経費上限はいくらですか?
    ```

    アップロードしたナレッジソースの情報に基づいた応答が返され、引用元の参照も表示されるはずです。

1. いくつか関連する質問を試してみましょう:
    - `航空券についてはどうですか?`
    - `接待費に関するガイドラインはありますか?`
    - `食事の経費上限はいくらですか?`

1. さらにいろいろな質問を試して、エージェントの応答を確認してください。機能は限定的ですが、経費精算に関する質問には適切な回答を提供できるはずです。

## チャレンジ

Copilot Studioでシンプルなエージェントを作る方法を学んだので、今度は学んだことを活かして自分でエージェントを作ってみましょう。Microsoft Copilotに関する質問に答えるエージェントを作成してみてください!

- 新しいエージェントを作成する
- `https://www.microsoft.com/ja-jp/microsoft-copilot/`と`https://learn.microsoft.com/ja-jp/copilot/`のWebサイトをナレッジソースとして登録する

> **ヒント**: わからないことがあれば、`https://learn.microsoft.com/ja-jp/microsoft-copilot-studio/`の[Copilot Studioドキュメント](https://learn.microsoft.com/ja-jp/microsoft-copilot-studio/)を参照してください。
